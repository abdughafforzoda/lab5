name: Trivy Security Scan

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Trivy
      run: |
        curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

    - name: Update Trivy database
      run: trivy image --download-db-only

    - name: Download HTML template
      run: |
        # Download the HTML template from Trivy's GitHub repo
        curl -sL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/html.tpl -o html.tpl

    - name: Run Trivy scan and generate outputs
      run: |
        # Generate JSON output first (we'll convert to HTML)
        trivy fs --format json --output trivy-results.json --severity CRITICAL,HIGH,MEDIUM .
        
        # Generate SBOM
        trivy fs --format spdx-json --output sbom.spdx.json .
        
        # Try to generate HTML with downloaded template
        trivy fs --format template --template "html.tpl" --output trivy-results.html . || echo "HTML generation with downloaded template failed"

    - name: Generate HTML from JSON (fallback)
      if: failure() || success()
      run: |
        # If HTML generation failed, create a simple HTML report from JSON
        if [ ! -f trivy-results.html ] || [ ! -s trivy-results.html ]; then
          echo "Creating simple HTML report from JSON..."
          cat > trivy-results.html << HTML
          <!DOCTYPE html>
          <html>
          <head>
              <title>Trivy Security Scan Report</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 20px; }
                  .vulnerability { border: 1px solid #ccc; margin: 10px 0; padding: 10px; }
                  .critical { background-color: #ffcccc; }
                  .high { background-color: #ffebcc; }
                  .medium { background-color: #ffffcc; }
              </style>
          </head>
          <body>
              <h1>Trivy Security Scan Report</h1>
              <p>Generated at: $(date)</p>
              <p>Note: Full HTML template not available. See trivy-results.json for complete details.</p>
              <p>Scan completed successfully. Check the JSON report for vulnerability details.</p>
          </body>
          </html>
          HTML
        fi

    - name: Upload SBOM as artifact
      uses: actions/upload-artifact@v4
      with:
        name: sbom
        path: sbom.spdx.json
        retention-days: 30

    - name: Upload security reports as artifacts
      uses: actions/upload-artifact@v4
      with:
        name: trivy-security-reports
        path: |
          trivy-results.html
          trivy-results.json
        retention-days: 30
